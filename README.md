# Subscription Bot

Telegram-бот для управления подписками на каналы с прогрессивным доступом.

## Возможности

### Для пользователей
- Автоматическая регистрация при подписке на материнский канал
- Прогрессивный доступ к дополнительным каналам по времени подписки
- Прогресс-бар с визуализацией до следующего канала
- Уведомления о скором открытии нового канала
- Настройка уведомлений

### Для администраторов
- Детальная статистика и аналитика (Retention, Churn rate)
- Логи всех действий пользователей
- Гибкое управление каналами через бота
- Массовые операции (выдача/отзыв доступа)
- Рассылка сообщений

## Структура проекта

```
Subscription_bot/
├── main.py              # Точка входа
├── config.py            # Конфигурация
├── database/
│   ├── db.py            # Подключение к SQLite
│   └── models.py        # ORM модели
├── handlers/
│   ├── user.py          # Обработчики пользователей
│   └── admin.py         # Админ-панель
├── services/
│   ├── subscription.py  # Логика подписок
│   └── scheduler.py     # Планировщик задач
├── utils/
│   ├── helpers.py       # Вспомогательные функции
│   └── messages.py      # Шаблоны сообщений
├── Dockerfile
└── docker-compose.yml
```

## Установка

### Локально (Poetry)

```bash
# Клонировать репозиторий
git clone https://github.com/maksimblak/Subscription_bot.git
cd Subscription_bot

# Установить зависимости
poetry install

# Создать .env файл
cp .env.example .env

# Заполнить .env (см. ниже)

# Запустить
poetry run python main.py
```

### Docker

```bash
# Создать .env файл
cp .env.example .env

# Заполнить .env

# Запустить
docker-compose up -d

# Посмотреть логи
docker-compose logs -f
```

## Конфигурация (.env)

```env
# Токен бота (от @BotFather)
BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz

# ID администраторов (через запятую)
ADMIN_IDS=123456789,987654321

# ID материнского канала
MAIN_CHANNEL_ID=-1001234567890

# Дополнительные каналы
CHANNEL_1_ID=-1001111111111
CHANNEL_1_NAME=Модуль 1

CHANNEL_2_ID=-1001222222222
CHANNEL_2_NAME=Модуль 2

CHANNEL_3_ID=-1001333333333
CHANNEL_3_NAME=Модуль 3

CHANNEL_4_ID=-1001444444444
CHANNEL_4_NAME=Модуль 4

# Время ежедневной проверки (по умолчанию 10:00)
SCHEDULER_HOUR=10
SCHEDULER_MINUTE=0
```

## Настройка каналов

1. Создайте бота через @BotFather
2. Добавьте бота **администратором** во все каналы:
   - Материнский канал
   - Все дополнительные каналы
3. Бот должен иметь права:
   - Приглашать пользователей
   - Банить пользователей
   - Читать сообщения (для отслеживания подписок)

## Команды

### Пользователи
| Команда | Описание |
|---------|----------|
| `/start` | Регистрация в боте |
| `/status` | Статус подписки и прогресс |
| `/channels` | Получить доступ к каналам |
| `/settings` | Настройки уведомлений |

### Администраторы
| Команда | Описание |
|---------|----------|
| `/admin` | Админ-панель |
| `/stats` | Быстрая статистика |
| `/broadcast <текст>` | Рассылка всем пользователям |

## Логика работы

### Регистрация
1. Пользователь подписывается на материнский канал
2. Нажимает `/start` в боте
3. Бот проверяет подписку и регистрирует пользователя
4. Выдаётся доступ к каналам с `days_required = 0`

### Прогрессивный доступ
Ежедневно в заданное время бот:
1. Проверяет всех активных пользователей
2. Считает дни подписки: `today - join_date`
3. Выдаёт доступ к новым каналам через invite link
4. Отправляет уведомления о скором открытии каналов

### Отписка
При отписке от материнского канала:
1. Пользователь удаляется из всех дополнительных каналов
2. Все сообщения с invite-ссылками удаляются
3. Статус в БД меняется на `inactive`

## База данных

SQLite с таблицами:
- `users` - пользователи
- `channels` - каналы
- `user_channels` - связь пользователей и каналов
- `action_logs` - логи действий
- `settings` - настройки бота

## Технологии

- Python 3.10+
- aiogram 3.x
- aiosqlite
- APScheduler
- Poetry
- Docker

## Лицензия

MIT
